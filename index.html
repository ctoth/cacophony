<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cacophony Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .button {
            padding: 10px;
            margin-right: 10px;
            cursor: pointer;
        }
        .disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #progressBar {
            width: 100%;
            height: 20px;
            background-color: #ddd;
            margin-top: 10px;
        }
        #progressFill {
            height: 100%;
            width: 0;
            background-color: #4CAF50;
            transition: width 0.1s;
        }
        #errorMessage {
            color: red;
            margin-top: 10px;
        }
    </style>
    <script type="module">
        import { Cacophony, SoundType, Sound } from '/src/index.ts';

        window.onload = () => {
            const cacophony = new Cacophony();
            window.cacophony = cacophony;
            let sound;
            let soundState = 'stopped';
            let progressInterval;

            const playPauseButton = document.getElementById('playPauseSound');
            const rewindButton = document.getElementById('rewindSound');
            const fastForwardButton = document.getElementById('fastForwardSound');
            const stopButton = document.getElementById('stopSound');
            const loadButton = document.getElementById('loadSound');
            const soundStateIndicator = document.getElementById('soundStateIndicator');
            const progressFill = document.getElementById('progressFill');
            const errorMessage = document.getElementById('errorMessage');

            const updateUIState = () => {
                playPauseButton.textContent = soundState === 'playing' ? 'Pause' : 'Play';
                soundStateIndicator.textContent = `Sound State: ${soundState}`;
                stopButton.disabled = soundState === 'stopped';
                playPauseButton.disabled = !sound;
                rewindButton.disabled = !sound;
                fastForwardButton.disabled = !sound;
                document.querySelectorAll('.control').forEach(control => {
                    control.disabled = !sound;
                });
            };

            const updateProgressBar = () => {
                if (sound && sound.playbacks[0] && sound.duration) {
                    const playback = sound.playbacks[0];
                    const progress = (playback.currentTime / sound.duration) * 100;
                    progressFill.style.width = `${progress}%`;
                }
            };

            const loadSound = async () => {
                const soundUrl = document.getElementById('soundUrl').value;
                try {
                    switch (soundUrl) {
                        case "sine":
                        case "sawtooth":
                        case "square":
                        case "triangle":
                            sound = await cacophony.createOscillator({
                                type: soundUrl,
                                panType: panType,
                            });
                            break;
                        default:
                            sound = await cacophony.createSound(soundUrl, SoundType.Buffer, panType);
                            break;
                    }
                    errorMessage.textContent = '';
                    updateUIState();
                } catch (error) {
                    errorMessage.textContent = `Error: ${error.message}`;
                    sound = undefined;
                    updateUIState();
                }
            };

            const togglePlayPause = () => {
                if (!sound) return;

                if (soundState === 'playing') {
                    sound.pause();
                    soundState = 'paused';
                    clearInterval(progressInterval);
                } else {
                    sound.play();
                    soundState = 'playing';
                    progressInterval = setInterval(updateProgressBar, 100);
                }
                updateUIState();
            };

            loadButton.addEventListener('click', loadSound);
            playPauseButton.addEventListener('click', togglePlayPause);

            stopButton.addEventListener('click', () => {
                if (sound) {
                    sound.stop();
                    soundState = 'stopped';
                    clearInterval(progressInterval);
                    progressFill.style.width = '0%';
                    updateUIState();
                }
            });

            rewindButton.addEventListener('click', () => {
                if (sound && sound.playbacks[0]) {
                    const playback = sound.playbacks[0];
                    const newTime = Math.max(0, playback.currentTime - 5);
                    sound.seek(newTime);
                    updateProgressBar();
                }
            });

            fastForwardButton.addEventListener('click', () => {
                if (sound && sound.playbacks[0]) {
                    const playback = sound.playbacks[0];
                    const newTime = Math.min(sound.duration, playback.currentTime + 5);
                    sound.seek(newTime);
                    updateProgressBar();
                }
            });

            document.getElementById('volume').addEventListener('input', (event) => {
                const volume = parseFloat(event.target.value);
                if (sound) sound.volume = volume;
            });

            const panTypeRadios = document.getElementsByName('panType');
            let panType = 'HRTF';
            panTypeRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.checked) {
                        panType = event.target.value;
                        if (sound) sound.panType = panType;
                        updateStereoPanVisibility();
                    }
                });
            });

            document.getElementById('positionX').addEventListener('input', (event) => {
                const x = parseFloat(event.target.value);
                if (sound) sound.position = [x, sound.position[1], sound.position[2]];
            });

            document.getElementById('stereoPan').addEventListener('input', (event) => {
                if (sound && sound.panType === 'stereo') {
                    const pan = parseFloat(event.target.value);
                    sound.stereoPan = pan;
                }
            });

            document.getElementById('loopCount').addEventListener('change', (event) => {
                if (sound) {
                    const loopCount = event.target.value === 'infinite' ? 'infinite' : parseInt(event.target.value, 10);
                    sound.loop(loopCount);
                }
            });

            const updateStereoPanVisibility = () => {
                const stereoPanSlider = document.getElementById('stereoPanContainer');
                stereoPanSlider.style.display = panType === 'stereo' ? 'block' : 'none';
            };

            document.addEventListener('keydown', (event) => {
                if (event.code === 'Space') {
                    event.preventDefault();
                    togglePlayPause();
                } else if (event.code === 'KeyS') {
                    stopButton.click();
                } else if (event.code === 'KeyL') {
                    loadButton.click();
                }
            });

            document.getElementById('progressBar').addEventListener('click', (event) => {
                if (sound && sound.playbacks[0] && sound.duration) {
                    const clickPosition = event.offsetX / event.target.offsetWidth;
                    const seekTime = clickPosition * sound.duration;
                    sound.seek(seekTime);
                    updateProgressBar();
                }
            });

            updateStereoPanVisibility();
            updateUIState();
        };
    </script>
</head>

<body>
    <h1>Cacophony Test Page</h1>
    <div class="control-group">
        <input type="text" id="soundUrl" placeholder="Enter sound URL or oscillator type">
        <button id="loadSound" class="button">Load Sound</button>
        <button id="playPauseSound" class="button" disabled>Play</button>
        <button id="rewindSound" class="button" disabled>⏪</button>
        <button id="fastForwardSound" class="button" disabled>⏩</button>
        <button id="stopSound" class="button" disabled>Stop</button>
    </div>
    <div id="soundStateIndicator">Sound State: stopped</div>
    <div id="progressBar">
        <div id="progressFill"></div>
    </div>
    <div class="control-group">
        <label for="volume">Volume:</label>
        <input type="range" id="volume" class="control" min="0" max="1" step="0.01" value="1" disabled>
    </div>
    <div class="control-group">
        <label for="positionX">Position X:</label>
        <input type="range" id="positionX" class="control" min="-10" max="10" step="0.1" value="0" disabled>
    </div>
    <div class="control-group">
        <label for="loopCount">Loop:</label>
        <select id="loopCount" class="control" disabled>
            <option value="0">No loop</option>
            <option value="1">1 time</option>
            <option value="2">2 times</option>
            <option value="5">5 times</option>
            <option value="infinite">Infinite</option>
        </select>
    </div>
    <div class="control-group">
        <label>Pan Type:</label>
        <input type="radio" id="panTypeHRTF" name="panType" value="HRTF" checked>
        <label for="panTypeHRTF">HRTF</label>
        <input type="radio" id="panTypeStereo" name="panType" value="stereo">
        <label for="panTypeStereo">Stereo</label>
    </div>
    <div id="stereoPanContainer" class="control-group" style="display: none;">
        <label for="stereoPan">Stereo Pan:</label>
        <input type="range" id="stereoPan" class="control" min="-1" max="1" step="0.01" value="0" disabled>
    </div>
    <div id="errorMessage"></div>
</body>

</html>
